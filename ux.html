<!DOCTYPE html>

<html>

<head>
	<meta http-equiv="Content-Type" content="text/html;charset=ISO-8859-1">
	<title>Attributes example</title>
	<script type="text/javascript" src='poly-map.js'></script>
	<script type="text/javascript" src='ttools.js'></script>
	<script type="text/javascript" src='templar-s.js'></script>
	<script type="text/javascript" src='json_websocket.js'></script>
	<style>
		.red {
			background-color: red;
		}

		.hide {
			display: none;
		}

		.local {
			background-color: lightblue;
		}

		.s3 {
			background-color: lightpink;
		}

		.both {
			background-color: lightgreen;
		}

		s {
			display: inline;
			text-decoration: none;
		}

		fc {
			display: flex;
			flex-direction: column;
			align-items: stretch;
		}

		fr {
			flex: 1;
			display: flex;
			flex-direction: row;
			border-bottom: 1px solid black;
		}

		fg {
			flex: 1;
		}

		fs {
			flex: 0 0;
			white-space: nowrap;
			display: inline-block;
			border: 1px solid gray;
		}

		ul {
			margin: 0px;
			padding: 3px 2em;
		}
	</style>
</head>

<body>
	<template id='root'>
		<div data-repeat-b='model.dirs'>
			<button on-click='{{buttonClick}}'>{{b.name}}</button>
		</div>
		<br/>
		<div>Current: <ul>
			<li>{{model.current.name}}</li>
			<li>{{model.current.args[0]}}</li>
			<li>{{model.current.args[1]}}</li>
		</ul></div>
		<br/>
		<div data-model-t='model.timer'>Scan status: <s>{{model.complete}}</s><br/>
			Scan time: <s>{:{qq('t.start') ? csn((qq('t.end')||Date.now()) - qq('t.start')) : '' }!}</s></div>
		<div data-model-s='model.fetch'>fetch: 
			<s>{{s.length}}</s> done: <s>{{s.done}}</s>
		</div>
		<br/>
		<div>Local/Both: <s data-template='#stat' data-model-s='model.stats.q'></s></div>
		<div>S3 only: <s data-template='#stat' data-model-s='model.stats.del'></s></div>
		<br/>
		<div>Equal: <s data-template='#stat' data-model-s='model.stats.eq'></s></div>
		<div>Skip: <s data-template='#stat' data-model-s='model.stats.skip'></s></div>
		<div>All: <s data-template='#stat' data-model-s='model.stats.all'></s></div>
		<br/>
		<br/>
		<input value-bind value="{{model.qfilter}}"/>
		<button on-click="{?{ctx.ist.recalc()}}">Filter</button>
		<fc data-template='#queue' data-repeat-q='model.queue'></fc>
	</template>

	<template id='stat'><s data-model-s'>
		<s>{:{csn(qq('s.len'))}}</s> - <s>{:{csn(qq('s.size'))}}</s>
	</s></template>

	<template id='queue'><fr data-model-q' on-click="{{qLogClick}}"
		class="{:{eqTxt(qq('q.eq'))}} {:{qFilter(qq)}}" >
		<fg >{{q.key}}</fg> 
		<fs>
			<b>{:{eqTxt(qq('q.eq'))}}</b> - <s>{:{csn(qq('q.size'))}}</s> 
			<!-- / <s>{{q.mtime}}</s> -->
		</fs>
	</fr></template>

	<div id='main'></div>
	<script>
		'use strict';
		function csn(n) { return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ','); }
		function eqTxt(eq) {
			if (eq === 1) return 'local';
			else if (eq > 1) return 'both';
			else return 's3';
		}
		function qFilter(qq) {
			var key = qq('q.key')
				, flt = qq('model.qfilter');
			var rx = new RegExp(flt, 'i');
			return rx.test(key) ? '' : 'hide';
		}
		function statPrint(s) { return csn(s.len) + '/' + csn(s.size); }
		var data = {
			queue: [],
			qfilter: '',
			timer: {}
		};
		var ctx = {
			buttonClick: function (ctx, path, qq, event) {
				data.queue.splice(0);
				data.complete = 'in progress';
				data.timer.start = Date.now(); data.timer.end = null;
				var entry = qq('b');
				data.current = entry;
				console.log('click', entry);
				window.jsonWsHandler.sendJson(entry.name, entry);
			},
			qLogClick: function (ctx, path, qq, event) {
				var entry = qq('q');
				console.log(entry);
			},
			debug: 0
		};
		var tmp = new Templar('#main', '#root', data, ctx);
		tmp.exec();
		//tmp.monLog();
		//tmp.recalc();

	</script>
	<script>
		'use strict';
		(function () {
			var jh = window.jsonWsHandler;

			console.log('ws://' + window.location.host + '/');
			var ws = new WebSocket('ws://' + window.location.host + '/');
			ws.onopen = function () {
				jh.addConn(ws);
				ws.onmessage = jh.ondata;
				jh.sendJson('asdf', { a: 1, b: 2 });
				var data = JSON.stringify({
					type: 'test',
					payload: 'hello world '//.repeat(4000)
				})
			};
			ws.onclose = function () { jh.remConn(ws); };
		})();
	</script>
	<script>
		/************************************************************************/
		// websocket event handlers:
		/************************************************************************/
		window.jsonWsHandler
			// .addCbJson(/.*/i, function (p, e) {
			// 	console.log(e, p);
			// })
			.addCbJson('init', addHandlers);

		function addHandlers(obj) {
			var ev = obj.events;
			tmp.model.dirs = obj.dirs;
			tmp.recalc();
			window.jsonWsHandler
				.addCbJson(ev.stats, function (s, e) {
					tmp.model.stats = s;
					tmp.recalc();
				})
				.addCbJson(ev.file_q, function (s, e) {
					tmp.model.queue.push(s);
					tmp.recalc();
				})
				.addCbJson(ev.get_remote, function (s, e) {
					tmp.model.fetch = s;
					tmp.recalc();
				})
				.addCbJson(ev.file_unused, function (s, e) {
					console.log('del', s);
					Array.prototype.push.apply(tmp.model.queue, s.files);
					tmp.recalc();
				})
				.addCbJson(ev.end, function (s, e) {
					tmp.model.complete = 'scan complete';
					console.log(s);
					tmp.model.timer.start = s.dt0;
					tmp.model.timer.end = s.dt1;
					tmp.recalc();
				});
		}
	</script>
</body>

</html>